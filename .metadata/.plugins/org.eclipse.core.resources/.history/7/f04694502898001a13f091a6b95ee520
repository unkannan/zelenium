package vich_file_creation.vich_file_creation;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.StringReader;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.swing.text.html.HTMLEditorKit.Parser;
import javax.xml.namespace.QName;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;

import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.JSONValue;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

public class XpathSupport {
	
	/** XML document */
	private Document xml;
	
	/** XPath intance */
	private XPath xpath;
	public XpathSupport() {}
	public XpathSupport(String xmlAsString) throws ParserConfigurationException, SAXException, IOException {
		DocumentBuilderFactory builderFactory = DocumentBuilderFactory.newInstance();
		DocumentBuilder builder = builderFactory.newDocumentBuilder();
		this.xml = builder.parse(new InputSource(new StringReader(xmlAsString)));
		
		this.xpath = XPathFactory.newInstance().newXPath();
	}
	
	
	
	public String string(String xpathExpression) throws XPathExpressionException {
		return (String) evaluate(xpathExpression, XPathConstants.STRING);
	}

	public Double number(String xpathExpression) throws XPathExpressionException {
		return (Double) evaluate(xpathExpression, XPathConstants.NUMBER);
	}

	private Object evaluate(String xpathExpression, QName returnType) throws XPathExpressionException {
		return xpath.compile(xpathExpression).evaluate(xml, returnType);
	}

/*
	public static void main(String args[]) throws ParserConfigurationException, SAXException, IOException, XPathExpressionException {
		System.out.println("Component1TC3");
		
		String filePath = "D:\\zelenium\\vichfiles\\MandatoryFields\\MainFile.xml";
		 
        String fileXML=( readAllBytesJava7( filePath ));
	
		XpathSupport xpath = new XpathSupport(fileXML);
	//	String msgackPath = "/PORR_IN049006UV/controlActProcess/subject/investigationEvent/subjectOf1/controlActEvent/author/assignedEntity/representedOrganization";
	//	String msgackPath = "/MCCI_IN200100UV01/creationTime/@value";
		String msgackPath = "/MCCI_IN200100UV01/PORR_IN049006UV/controlActProcess/subject/investigationEvent/subjectOf1/controlActEvent/primaryInformationRecipient/assignedEntity[code/@code=\"T95009\"]/addr/country";
		String k=xpath.string(String.format("%s", msgackPath));
		System.out.println(k.replaceAll("\\s+", " "));
	}*/
	 
    private static String readAllBytesJava7(String filePath) 
    {
        String content = "";
        try
        {
            content = new String ( Files.readAllBytes( Paths.get(filePath) ) );
        } 
        catch (IOException e) 
        {
            e.printStackTrace();
        }
        return content;
    }
	
	public void modify(String fileXML, String xpath, String value,String newfilename) throws ParserConfigurationException,
			SAXException, IOException, XPathExpressionException, TransformerException {
		DocumentBuilderFactory f = DocumentBuilderFactory.newInstance();
		DocumentBuilder b = f.newDocumentBuilder();
		Document doc = b.parse(fileXML);
		XPath xPath = XPathFactory.newInstance().newXPath();
		System.out.println(xpath);

		Node startDateNode = (Node) xPath.compile(xpath).evaluate(doc, XPathConstants.NODE);
		System.out.println(startDateNode.getTextContent());
		startDateNode.setTextContent(value);

		// write the content into xml file
		TransformerFactory transformerFactory = TransformerFactory.newInstance();
		Transformer transformer = transformerFactory.newTransformer();
		DOMSource source = new DOMSource(doc);
		StreamResult result = new StreamResult(new File(newfilename));
		transformer.transform(source, result);

		System.out.println("Done");
	}
	
//	public <dataclass> void getJason(String jsonstr) throws ParseException, JsonParseException, JsonMappingException, IOException {
		@SuppressWarnings("unchecked")
	//	public static void main(String args[]) throws ParseException {
		public void getJason(String jsonstr) {
	//	String jsonstr="{\"field\":\"NewField\",\"value\":\"newValue\"},{\"field\":\"NewField2fdsfs\",\"value\":\"newValue2\"}";
		String jsonstr1="{\"units\":[\r\n" + 
				"    {\r\n" + 
				"        \"xmlxpath\": {\r\n" + 
				"            \"field\": \"Lokesh\",\r\n" + 
				"            \"value\": \"Gupta\",\r\n" + 
				"        }\r\n" + 
				"    },\r\n" + 
				"    {\r\n" + 
				"        \"xmlxpath\": {\r\n" + 
				"            \"field\": \"Brian\",\r\n" + 
				"            \"value\": \"Schultz\",\r\n" + 
				"        }\r\n" + 
				"    }\r\n" + 
				"]}";
		String jsonstr2="{\r\n" + 
				"        \"xmlxpath\": {\r\n" + 
				"            \"field\": \"Lokesh\",\r\n" + 
				"            \"value\": \"Gupta\",\r\n" + 
				"        }\r\n" + 
				"    },\r\n" + 
				"    {\r\n" + 
				"        \"xmlxpath\": {\r\n" + 
				"            \"field\": \"Brian\",\r\n" + 
				"            \"value\": \"Schultz\",\r\n" + 
				"        }\r\n" + 
				"    }";
		String jsonstr3="[\r\n" + 
				"  {\r\n" + 
				"    \"name\": \"John Doe\",\r\n" + 
				"    \"occupation\": \"gardener\",\r\n" + 
				"    \"born\": \"1992-03-02\"\r\n" + 
				"  },\r\n" + 
				"  {\r\n" + 
				"    \"name\": \"Brian Flemming\",\r\n" + 
				"    \"occupation\": \"teacher\",\r\n" + 
				"    \"born\": \"1967-11-22\"\r\n" + 
				"  },\r\n" + 
				"  {\r\n" + 
				"    \"name\": \"Lucy Black\",\r\n" + 
				"    \"occupation\": \"accountant\",\r\n" + 
				"    \"born\": \"1995-04-07\"\r\n" + 
				"  },\r\n" + 
				"  {\r\n" + 
				"    \"name\": \"William Bean\",\r\n" + 
				"    \"occupation\": \"pilot\",\r\n" + 
				"    \"born\": \"1977-10-31\"\r\n" + 
				"  }\r\n" + 
				"]";
		String jsonstr4="{\r\n" + 
				"    \"name\": \"John Doe\",\r\n" + 
				"    \"occupation\": \"gardener\",\r\n" + 
				"    \"born\": \"1992-03-02\"\r\n" + 
				"  },\r\n" + 
				"  {\r\n" + 
				"    \"name\": \"Brian Flemming\",\r\n" + 
				"    \"occupation\": \"teacher\",\r\n" + 
				"    \"born\": \"1967-11-22\"\r\n" + 
				"  },\r\n" + 
				"  {\r\n" + 
				"    \"name\": \"Lucy Black\",\r\n" + 
				"    \"occupation\": \"accountant\",\r\n" + 
				"    \"born\": \"1995-04-07\"\r\n" + 
				"  },\r\n" + 
				"  {\r\n" + 
				"    \"name\": \"William Bean\",\r\n" + 
				"    \"occupation\": \"pilot\",\r\n" + 
				"    \"born\": \"1977-10-31\"\r\n" + 
				"  }";
		
		String jsonstr5= "{\r\n" + 
				"\"xpath\":[\r\n" + 
				"{ \"field\":\"Avengers\",\r\n" + 
				"\"value\":\"2012\"\r\n" + 
				"},\r\n" + 
				"{\"field\":\"Avengers2\",\r\n" + 
				"\"value\":\"2014\"\r\n" + 
				"}\r\n" + 
				"]\r\n" + 
				"}";
		
	//	String jsonstr6="{\"xpath\":[{ \"field\":\"Avengers\",\"value\":\"2012\"},{\"field\":\"Avengers2\",\"value\":\"2014\"},{\"field\":\"Avengers3\",\"value\":\"2016\"}]}";
		  JSONParser parser = new JSONParser();
		
		 JSONObject parentObject=(JSONObject) parser.parse(jsonstr);
		 JSONArray parentArray=(JSONArray) parentObject.get("xpath");
		 
		 int i=0;
		 System.out.println(parentArray.size());
		 while(i<parentArray.size()) {
		 JSONObject finalObject=(JSONObject) parentArray.get(i++);
		  System.out.println(finalObject.get("field"));
		  System.out.println(finalObject.get("value"));
		 }
		  
		 	
		    }
		private static void parsexmlxpathObject(JSONObject xmlxpath) 
	    {
	        //Get employee object within list
	        JSONObject xmlxpathObject = (JSONObject) xmlxpath.get("xmlxpath");
	         
	        //Get employee first name
	        String firstName = (String) xmlxpathObject.get("field");    
	        System.out.println(firstName);
	         
	        //Get employee last name
	        String lastName = (String) xmlxpathObject.get("value");  
	        System.out.println(lastName);
	         
	    }
}